<link rel="import" href="/vendor/polymer/polymer.html">
<link rel="import" href="/web-components/museum/form/cuac-schedule-days.html">
<link rel="import" href="/web-components/museum/form/cuac-schedule-hours.html">

<dom-module id="cuac-schedule-form">
    <template>
        <cuac-schedule-days class="col-md-12" checked="{{marked}}" selection="{{selectedDays}}"></cuac-schedule-days>
        <cuac-schedule-hours id="hours" class="col-md-12" days="{{selectedDays}}" selection="{{selectedHours}}"></cuac-schedule-hours>
        <div class="panel col-md-12">
            <template is="dom-repeat" items="{{renderedSchedule}}">
                <div>
                    <label>{{item.day}}</label>
                    <template is="dom-repeat" items="{{item.hours}}" as="hours">
                        <span class="editable-hour" data-day="{{item.day}}" contenteditable$="{{editable}}" on-focus="removeHour" on-blur="checkHour" on-keyup="detectHour"> {{hours}} </span>
                    </template>
                </div>
            </template>
        </div>
    </template>
    <script>
        Polymer({
            is: 'cuac-schedule-form',

            ready: function() {
                this.hours = document.getElementById('hours');
                this.saveButton = document.getElementById('action');
            },

            properties: {

                selectedDays: {type: Array, value: []},

                marked: {type: Boolean, value: false},

                editable: {type: Boolean, value: false},

                selectedHours: {type: String, observer: 'arrangeSchedule'},

                scheduleData: {type: Object},

                renderedSchedule: {type: Array}

            },

            detectHour: function(e) {
                e.preventDefault();
                this.editedHour = e.target.innerText;
                this.saveButton.active = this.hours.isValid(this.editedHour);
            },

            checkHour: function(e) {
                e.preventDefault();
                var day = e.target.dataDay;
                if(this.hours.isValid(this.editedHour)){
                    this.saveButton.active = this.hours.isValid(this.editedHour)
                    this.scheduleData[day].push(this.editedHour)
                    this.removeDuplicateHours(day)
                }
            },

            removeHour: function(e) {
                e.preventDefault();
                var day = e.target.dataDay;
                var oldHour = e.target.innerText;
                var index = this.scheduleData[day].indexOf(oldHour);
                if(index > -1){
                    this.scheduleData[day].splice(index, 1);
                }
            },

            arrangeSchedule: function() {
                this.storeSchedule();
                this.generateRenderedSchedule();
                this.initializeSchedule();
            },

            storeSchedule: function() {
                this.selectedDays.forEach(function(day) {
                    this.scheduleData[day].push(this.selectedHours);
                    var duplicateHoursRemoved = this.removeDuplicateHours(day);
                    this.sortScheduleHours(day, duplicateHoursRemoved);
                }.bind(this));
            },

            removeDuplicateHours: function (day) {
                var duplicateHoursRemoved = this.scheduleData[day].filter(function(hours, index, self) {
                    return index == self.indexOf(hours);
                });
                return duplicateHoursRemoved;
            },

            sortScheduleHours: function(day, duplicateHoursRemoved) {
                this.scheduleData[day] = duplicateHoursRemoved.sort();
            },

            generateRenderedSchedule: function() {
                var schedule = [];
                for (var day in this.scheduleData) {
                    if (this.scheduleData[day].length > 0) {
                        var object = {};
                        object.day = day;
                        object.hours = this.scheduleData[day];
                        schedule.push(object);
                    }
                }
                this.polymerWorkaround(schedule);
            },

            polymerWorkaround: function(schedule) {
                this.renderedSchedule = schedule;
                var temp = this.renderedSchedule;
                this.renderedSchedule = [];
                this.renderedSchedule = temp;
            },

            initializeSchedule: function() {
                this.selectedHours = null;
                this.selectedDays = [];
                this.marked = true;
                this.marked = false;
            }
        });
    </script>
</dom-module>
